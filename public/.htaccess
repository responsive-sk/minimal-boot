RewriteEngine On

# HTTP/2 Server Push for critical resources
<IfModule mod_headers.c>
    # Push critical CSS and JS for faster loading
    <FilesMatch "\.html?$">
        Header add Link "</themes/svelte/assets/main.css>; rel=preload; as=style"
        Header add Link "</themes/svelte/assets/main.js>; rel=preload; as=script"
        Header add Link "</images/app/logo.svg>; rel=preload; as=image"
    </FilesMatch>
</IfModule>

# Font MIME types (correct modern MIME types)
AddType font/woff2 .woff2
AddType font/woff .woff
AddType font/ttf .ttf
AddType font/otf .otf

# Compression for better performance
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# CORS headers for fonts
<FilesMatch "\.(woff2?|eot|ttf|otf)$">
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET"
    Header set Access-Control-Allow-Headers "Content-Type"
</FilesMatch>

# Cache Control Headers for Performance
<IfModule mod_expires.c>
    ExpiresActive On

    # Fonts - 1 year cache (immutable)
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"

    # CSS and JS - 1 year cache (with versioning/hashing)
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"

    # Images - 1 year cache (static assets)
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/ico "access plus 1 year"

    # HTML - 1 hour cache
    ExpiresByType text/html "access plus 1 hour"

    # Manifest and service worker - 1 day cache
    ExpiresByType application/manifest+json "access plus 1 day"
    ExpiresByType text/cache-manifest "access plus 1 day"
</IfModule>

# Alternative Cache-Control headers if mod_expires is not available
<IfModule mod_headers.c>
    # Fonts - 1 year cache with immutable
    <FilesMatch "\.(woff2?|eot|ttf|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # CSS and JS - 1 year cache (versioned assets)
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Images - 1 year cache with immutable
    <FilesMatch "\.(svg|png|jpg|jpeg|webp|gif|ico)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # HTML - 1 hour cache
    <FilesMatch "\.html?$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>

    # Manifest files - 1 day cache
    <FilesMatch "\.(manifest|json)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>

    # Security and Performance Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # Preload critical resources
    <FilesMatch "index\.php$">
        Header add Link "</themes/svelte/assets/main.css>; rel=preload; as=style"
        Header add Link "</images/app/logo.svg>; rel=preload; as=image"
    </FilesMatch>
</IfModule>

# The following rule allows authentication to work with fast-cgi
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
# The following rule tells Apache that if the requested filename
# exists, simply serve it.
RewriteCond %{REQUEST_FILENAME} -s [OR]
RewriteCond %{REQUEST_FILENAME} -l [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^.*$ - [NC,L]

# The following rewrites all other queries to index.php. The
# condition ensures that if you are using Apache aliases to do
# mass virtual hosting, the base path will be prepended to
# allow proper resolution of the index.php file; it will work
# in non-aliased environments as well, providing a safe, one-size
# fits all solution.
RewriteCond %{REQUEST_URI}::$1 ^(/.+)(.+)::\2$
RewriteRule ^(.*) - [E=BASE:%1]
RewriteRule ^(.*)$ %{ENV:BASE}index.php [NC,L]
